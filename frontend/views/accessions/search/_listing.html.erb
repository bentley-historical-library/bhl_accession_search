<% if @search_data.results? %>
  <% add_identifier_column if show_identifier_column? %> 
  
  <%= render_aspace_partial :partial => "shared/pagination_summary" %>

  <div class="clearfix"></div>

  <div class="panel-group">
    <% @search_data['results'].each_with_index do |result, index|
      result_json = JSON.parse(result["json"])

      extent_statements = []
      result_json["extents"].each do |extent|
        extent_number = extent["number"]
        extent_type = I18n.t('enumerations.extent_extent_type.' + extent["extent_type"], :default => extent["extent_type"])
        extent_statements << "#{extent_number} #{extent_type}"
      end

      donor = result_json["linked_agents"][0] ? result_json["linked_agents"][0]["_resolved"] : nil
      if donor
        donor_name = donor["title"]
        donor_number = donor["donor_details"][0] ? donor["donor_details"][0]["donor_number"] : "No Donor Number"
      end

      collection_management = result_json["collection_management"] ? result_json["collection_management"] : nil
      if collection_management
        processing_status = collection_management["processing_status"] ? collection_management["processing_status"] : nil
        processing_priority = collection_management["processing_priority"] ? collection_management["processing_priority"] : nil
      end

      content_date = result_json["dates"][0] ? result_json["dates"][0]["expression"] : nil
      content_description = result_json["content_description"] ? result_json["content_description"] : nil
     %>

    <div class="panel panel-default">
      <div class="panel-heading">
        <div><span>Accession</span></div>
      </div>
      <div class="panel-body">
        <p>Title: <%=  clean_mixed_content(result["title"]).html_safe || clean_mixed_content(result['display_string']).html_safe %></p>
        <% if content_date %>
          <p>Date: <%= content_date %></p>
        <% end %>
        <% if extent_statements.length > 0 %>
          <p>Extent: <%= extent_statements.join(", ") %></p>
        <% end %>
        <p>Accession Date: <%= result_json["accession_date"] %></p>
        <p>Description: <%= clean_mixed_content("#{content_description}").html_safe %></p>
        <% if collection_management %>
          <% if processing_status %>
            <p>Processing Status: <%= "#{processing_status}" %></p>
          <% end %>
          <% if processing_priority %>
            <p>Processing Priority: <%= "#{processing_priority}" %></p>
          <% end %>
        <% end %>
        <% if donor %>
          <p>Donor: <%= "#{donor_name} (#{donor_number})" %></p>
        <% end %>
        <%= link_to I18n.t("actions.view"), {:controller => :resolver, :action => :resolve_readonly, :uri => result["id"]}, :class => "btn btn-block btn-primary" %>
        <% if can_edit_search_result?(result) %>
          <%= link_to I18n.t("actions.edit"), {:controller => :resolver, :action => :resolve_edit, :uri => result["id"]}, :class => "btn btn-block btn-info" %>
        <% end %>
      </div>
      <div class="panel-footer">
        <div class="row collapsed" data-toggle="collapse" href="#search_result_<%= index %>">
          <div class="col-md-7">View Result JSON</div>
        </div>
        <div class="collapse" id="search_result_<%= index %>">
          <%= result %>
        </div>
      </div>
    </div>

    <% end %>
  </div>
  
   <table id="tabledSearchResults" class="table table-striped table-bordered table-condensed table-hover table-sortable table-search-results" <% if allow_multi_select? %>data-multiselect="true"<% end %>>
    <thead>
    <tr>
      <% if allow_multi_select? %>
        <th></th>
      <% end %>
      <% if params[:linker]==='true' %>
        <th></th>
      <% end %>
      <% if show_record_type? %>
        <th class="col record-type sortable <% if @search_data.sorted_by === "primary_type"%>sort-<%= @search_data.current_sort_direction %><% end %>">
          <%= link_to I18n.t("search_results.result_type"), build_search_params("sort" => @search_data.sort_filter_for("primary_type")) %>
        </th>
      <% end %>
      <% if show_title_column? %>
        <th class="col title sortable <% if @search_data.sorted_by === "title_sort"%>sort-<%= @search_data.current_sort_direction %><% end %>">
          <%= link_to title_column_header_label, build_search_params("sort" => @search_data.sort_filter_for("title_sort")) %>
        </th>
      <% end %>
      <% if extra_columns? %>
        <% extra_columns.each do |col| %>
          <th class="<%= col.class %>">
            <% if col.sortable? %>
              <%= link_to col.label, build_search_params("sort" => @search_data.sort_filter_for(col.sort_by)) %>
            <% else %>
              <%= col.label %>
            <% end %>
          </th>
        <% end %>
      <% end %>
      <th class="col audit-info"></th>
      <% if !params[:linker] || params[:linker] === 'false' %>
        <th class="col actions"><!-- actions --></th>
      <% end %>
    </tr>
    </thead>
    <tbody>
    <% @search_data['results'].each do |result| 
      deleted = (params.has_key?("deleted_uri") and Array(params["deleted_uri"]).include?(result["id"])) || false
    %>
      <tr class="<%= "deleted" if deleted %>">
        <% if allow_multi_select? %>
          <td class="multiselect-column">
            <%= check_box_tag "multiselect-item", result["id"], false %>
          </td>
        <% end %>
        <% if params[:linker] === 'true' %>
          <% if params[:multiplicity] === 'many' %>
            <td>
              <%= check_box_tag "linker-item", result["id"], false, :"data-object" => result.to_json %>
            </td>
          <% else %>
            <td>
              <%= radio_button_tag "linker-item", result["id"], false, :"data-object" => result.to_json %>
            </td>
          <% end %>
        <% end %>
        <% if show_record_type? %>
          <td>
             <%=  I18n.t("#{result["primary_type"]}._singular", :default => I18n.t("plugins.#{result["primary_type"]}._singular")) %>
          </td>
        <% end %>
        <% if show_title_column? %>
          <td>
            <% if result['primary_type'] === "repository" and session[:repo] === result['id'] %><span class="label label-success"><%= I18n.t("repository._frontend.messages.selected_short") %></span><% end %>
            <% if result["suppressed"] %><span class="label label-info"><%= I18n.t("states.suppressed") %></span><% end %>
            <% if deleted %><span class="label label-important"><%= I18n.t("states.deleted") %></span><% end %>
          <%=  clean_mixed_content(result["title"]).html_safe || clean_mixed_content(result['display_string']).html_safe %>
          </td>
        <% end %>
        <% if extra_columns? %>
          <% extra_columns.each do |col| %>
            <td><%= col.value_for(result) %></td>
          <% end %>
        <% end %>
        <td>
          <%= display_audit_info(result, :format => 'compact') %>
        </td>
        <% if !params[:linker] || params[:linker] === 'false' %>
          <td class="table-record-actions">
            <% if not deleted %>
              <div class="btn-group">
                <%= link_to I18n.t("actions.view"), {:controller => :resolver, :action => :resolve_readonly, :uri => result["id"]}, :class => "btn btn-xs btn-default" %>
                <% if can_edit_search_result?(result) %>
                  <%= link_to I18n.t("actions.edit"), {:controller => :resolver, :action => :resolve_edit, :uri => result["id"]}, :class => "btn btn-xs btn-primary" %>
                <% end %>
              </div>
              <% if result['primary_type'] === "repository" and @repositories.any?{|r| r['uri'] === result['id']} %>

                <% if current_repo['uri'] != result['id'] %>
                  <%= form_tag({:action => :select, :id => JSONModel(:repository).id_for(result['id'])}, {:style => "display: inline;"}) do |f| %>
                    <button type="submit" class="btn btn-xs btn-success"><%= I18n.t("repository._frontend.action.select") %></button>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          </td>
        <% end %>
      </tr>
    <% end %>
    </tbody>
  </table>
  <%= render_aspace_partial :partial => "shared/pagination" %>
<% else %>
  <p class="alert alert-info">
    HEY IT'S WORKING
  </p>
<% end %>
